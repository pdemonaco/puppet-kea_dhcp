name: 20 - PDK

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  syntax:
    name: Syntax Validation (Puppet ${{ matrix.puppet_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        puppet_version: ['7', '8']
        include:
          - puppet_version: '7'
            puppet_gem: '~> 7.0'
          - puppet_version: '8'
            puppet_gem: '~> 8.0'
    env:
      PUPPET_GEM_VERSION: ${{ matrix.puppet_gem }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path vendor/bundle
          bundle config set --local without system_tests
          bundle install --jobs 4 --retry 3

      - name: Validate syntax and metadata
        run: bundle exec rake validate lint

  unit:
    name: Unit Tests (Puppet ${{ matrix.puppet_version }})
    runs-on: ubuntu-latest
    needs: syntax
    strategy:
      fail-fast: false
      matrix:
        puppet_version: ['7', '8']
        include:
          - puppet_version: '7'
            puppet_gem: '~> 7.0'
          - puppet_version: '8'
            puppet_gem: '~> 8.0'
    env:
      PUPPET_GEM_VERSION: ${{ matrix.puppet_gem }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path vendor/bundle
          bundle config set --local without system_tests
          bundle install --jobs 4 --retry 3

      - name: Run unit test suite
        run: bundle exec rake spec

#  acceptance:
#    name: Acceptance Tests
#    runs-on: ubuntu-latest
#    env:
#      PUPPET_GEM_VERSION: '~> 8.0'
#      BOLT_INVENTORY: spec/fixtures/litmus_inventory.yaml
#      BOLT_SSH_HOST_KEY_CHECK: "false"
#      BOLT_LOG_LEVEL: "debug"
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Set up Ruby
#        uses: ruby/setup-ruby@v1
#        with:
#          ruby-version: '3.2'
#
#      - name: Install dependencies
#        run: |
#          gem install bundler
#          bundle config set --local path vendor/bundle
#          bundle config set --local with system_tests
#          bundle install --jobs 4 --retry 3
#
#      - name: Check for acceptance tests
#        id: check_tests
#        run: |
#          if compgen -G "spec/acceptance/*_spec.rb" > /dev/null; then
#            echo "has_tests=true" >> "$GITHUB_OUTPUT"
#          else
#            echo "has_tests=false" >> "$GITHUB_OUTPUT"
#            echo "No acceptance tests found. Skipping acceptance suite."
#          fi
#
#      - name: Provision test environment
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: bundle exec rake 'litmus:provision_list[default]'
#
#      - name: Fix inventory for IPv4
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: sed -i 's/localhost:/127.0.0.1:/g' spec/fixtures/litmus_inventory.yaml
#
#      - name: Show Litmus inventory (debug)
#        run: |
#          ls -la spec/fixtures || true
#          ls -la spec/fixtures/litmus_inventory.yaml || true
#          sed -n '1,200p' spec/fixtures/litmus_inventory.yaml || true
#
#      - name: List Test Nodes
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: docker ps
#
#      - name: Wait for SSH and remove nologin files
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: |
#          # Wait for sshd to be running in all containers
#          for container in $(docker ps -q); do
#            echo "Waiting for sshd on $container..."
#            for i in {1..30}; do
#              if docker exec $container pgrep -x sshd > /dev/null 2>&1; then
#                echo "sshd is running on $container"
#                break
#              fi
#              sleep 1
#            done
#            # Remove nologin files (Rocky 9 doesn't remove them automatically in containers)
#            docker exec $container rm -f /run/nologin /var/run/nologin /etc/nologin 2>/dev/null || true
#          done
#
#      - name: Setup SSH key authentication
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: |
#          # Generate SSH key pair
#          ssh-keygen -t ed25519 -f ~/.ssh/litmus_key -N '' -q
#
#          # Inject public key into all containers
#          for container in $(docker ps -q); do
#            echo "Setting up SSH key auth on container $container"
#            docker exec $container mkdir -p /root/.ssh
#            docker exec $container chmod 700 /root/.ssh
#            docker cp ~/.ssh/litmus_key.pub $container:/root/.ssh/authorized_keys
#            docker exec $container chmod 600 /root/.ssh/authorized_keys
#            docker exec $container chown -R root:root /root/.ssh
#          done
#
#          # Update inventory to use SSH key instead of password
#          sed -i 's/password: root/private-key: ~\/.ssh\/litmus_key/' spec/fixtures/litmus_inventory.yaml
#
#          # Verify SSH works
#          ROCKY9_ID=$(docker ps --filter "ancestor=litmusimage/rockylinux:9" -q)
#          ROCKY9_PORT=$(docker port $ROCKY9_ID 22 | cut -d: -f2)
#          ssh -i ~/.ssh/litmus_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@127.0.0.1 -p $ROCKY9_PORT 'echo SSH key auth works'
#
#      - name: Install Puppet agent
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: bundle exec rake litmus:install_agent --trace
#
#      - name: Install module
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: bundle exec rake litmus:install_module
#
#      - name: Run acceptance tests
#        if: steps.check_tests.outputs.has_tests == 'true'
#        run: bundle exec rake litmus:acceptance:parallel
#
#      - name: Tear down test environment
#        if: always() && steps.check_tests.outputs.has_tests == 'true'
#        run: bundle exec rake litmus:tear_down
