name: 20 - PDK

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  syntax:
    name: Syntax Validation (Puppet ${{ matrix.puppet_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        puppet_version: ['7', '8']
        include:
          - puppet_version: '7'
            puppet_gem: '~> 7.0'
          - puppet_version: '8'
            puppet_gem: '~> 8.0'
    env:
      PUPPET_GEM_VERSION: ${{ matrix.puppet_gem }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path vendor/bundle
          bundle config set --local without system_tests
          bundle install --jobs 4 --retry 3

      - name: Validate syntax and metadata
        run: bundle exec rake validate lint

  unit:
    name: Unit Tests (Puppet ${{ matrix.puppet_version }})
    runs-on: ubuntu-latest
    needs: syntax
    strategy:
      fail-fast: false
      matrix:
        puppet_version: ['7', '8']
        include:
          - puppet_version: '7'
            puppet_gem: '~> 7.0'
          - puppet_version: '8'
            puppet_gem: '~> 8.0'
    env:
      PUPPET_GEM_VERSION: ${{ matrix.puppet_gem }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path vendor/bundle
          bundle config set --local without system_tests
          bundle install --jobs 4 --retry 3

      - name: Run unit test suite
        run: bundle exec rake spec

  acceptance:
    name: Acceptance Tests
    runs-on: ubuntu-latest
    needs: unit
    env:
      PUPPET_GEM_VERSION: '~> 8.0'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies
        run: |
          gem install bundler
          bundle config set --local path vendor/bundle
          bundle config set --local with system_tests
          bundle install --jobs 4 --retry 3

      - name: Check for acceptance tests
        id: check_tests
        run: |
          if compgen -G "spec/acceptance/*_spec.rb" > /dev/null; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
            echo "No acceptance tests found. Skipping acceptance suite."
          fi

      - name: Provision test environment
        if: steps.check_tests.outputs.has_tests == 'true'
        run: bundle exec rake 'litmus:provision_list[default]'

      - name: Install Puppet agent
        if: steps.check_tests.outputs.has_tests == 'true'
        run: bundle exec rake litmus:install_agent

      - name: Install module
        if: steps.check_tests.outputs.has_tests == 'true'
        run: bundle exec rake litmus:install_module

      - name: Run acceptance tests
        if: steps.check_tests.outputs.has_tests == 'true'
        run: bundle exec rake litmus:acceptance:parallel

      - name: Tear down test environment
        if: always() && steps.check_tests.outputs.has_tests == 'true'
        run: bundle exec rake litmus:tear_down
